{% extends "base.html" %}

{% block title %}Taller - American Tint{% endblock %}
{% block page_title %}Mi Taller{% endblock %}

{% block content %}

<div class="row">
  <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
    <div class="card">
      <div class="card-header p-3 pt-2">
        <div class="icon icon-lg icon-shape bg-gradient-info shadow-info text-center border-radius-xl mt-n4 position-absolute">
          <i class="material-icons opacity-10">inventory</i>
        </div>
        <div class="text-end pt-1">
          <p class="text-sm mb-0 text-capitalize">Stock Asignado</p>
          <h4 class="mb-0">{{ rollos|length }} Rollos</h4>
        </div>
      </div>
      <hr class="dark horizontal my-0">
      <div class="card-footer p-3">
        <p class="mb-0"><span class="text-success text-sm font-weight-bolder">Listo </span>para instalar</p>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <h6 class="mb-0">游닍 Mis Rollos Disponibles</h6>
        <p class="text-sm mb-0">Selecciona un rollo para generar una garant칤a.</p>
    </div>
</div>

<div class="row mt-3">
    {% for item in rollos %}
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header p-3 pt-2">
                <div class="icon icon-lg icon-shape {{ 'bg-gradient-secondary' if item.disponibles == 0 else 'bg-gradient-success' }} shadow text-center border-radius-xl mt-n4 position-absolute">
                    <i class="material-icons opacity-10">qr_code</i>
                </div>
                <div class="text-end pt-1">
                    <p class="text-sm mb-0 text-capitalize">C칩digo Padre</p>
                    <h5 class="mb-0">{{ item.obj.codigo_padre }}</h5>
                </div>
            </div>

            <div class="card-body p-3">
                <div class="d-flex justify-content-between text-xs mb-1">
                    <span>Progreso de Uso</span>
                    <span>{{ item.usados }}/{{ item.total }} Cupos</span>
                </div>
                <div class="progress mb-3">
                    <div class="progress-bar bg-gradient-warning" role="progressbar" style="width: {{ item.porcentaje|default(0) ~ '%' }}"></div>
                </div>
                
                <p class="text-sm mb-0">
                    <i class="fa fa-calendar text-secondary"></i> Recibido: {{ item.obj.fecha_asignacion.strftime('%d/%m/%Y') if item.obj.fecha_asignacion else 'Reciente' }}
                </p>
            </div>

            <div class="card-footer p-3 border-top">
                {% if item.disponibles > 0 %}
                    <button class="btn bg-gradient-dark w-100 mb-0" data-bs-toggle="modal" data-bs-target="#modalGarantia{{ item.obj.id }}">
                        <i class="material-icons text-sm">send</i>&nbsp;&nbsp;Iniciar Garant칤a
                    </button>
                {% else %}
                    <button class="btn btn-outline-secondary w-100 mb-0" disabled>Agotado</button>
                {% endif %}
            </div>
        </div>

        <div class="modal fade" id="modalGarantia{{ item.obj.id }}" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title font-weight-normal">Nueva Instalaci칩n</h5>
                        <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form action="{{ url_for('installer.create_warranty') }}" method="POST">
                            <input type="hidden" name="rollo_id" value="{{ item.obj.id }}">
                            
                            <p class="text-sm text-secondary mb-4">
                                Se enviar치 un email al cliente para que complete sus datos y active la garant칤a.
                            </p>

                            <div class="input-group input-group-outline mb-3">
                                <label class="form-label">Patente del Veh칤culo *</label>
                                <input type="text" name="patente" class="form-control" required style="text-transform: uppercase;">
                            </div>

                            <div class="input-group input-group-outline mb-3">
                                <label class="form-label">Email del Cliente *</label>
                                <input type="email" name="email" class="form-control" required>
                            </div>

                            <div class="text-center">
                                <button type="submit" class="btn bg-gradient-info w-100 mt-3">Enviar Invitaci칩n 游닎</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-warning text-white" role="alert">
            <strong>Atenci칩n:</strong> No tienes rollos asignados. Contacta al administrador.
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}